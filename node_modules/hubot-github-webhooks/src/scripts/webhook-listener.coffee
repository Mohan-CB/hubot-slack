# Description
#   Emit review-needed and review-complete events based on
#   GitHub pull_request WebHook Events

module.exports = (robot) ->
  robot.router.post '/hubot/gh', (req, res) ->
    robot.logger.debug "GitHub webhook request received of type #{req.get('X-GitHub-Event')}."
    robot.emit 'github', req.body

    if req.get('X-GitHub-Event')
      robot.logger.debug "Emitted Github #{req.get('X-GitHub-Event')} event for #{req.body.repository?.name}"
      robot.emit "github.#{req.get('X-GitHub-Event')}", req.body

      if req.body.action?
        robot.logger.debug "Emitted github.#{req.get('X-GitHub-Event')}.#{req.body.action} event for #{req.body.repository?.name}}"
        robot.emit "github.#{req.get('X-GitHub-Event')}.#{req.body.action}", req.body

    # There are a few weird events that aren't properly handled by the above code
    # We'll manually handle them here...

    if req.get('X-GitHub-Event') == 'push' and req.body.forced
      robot.logger.debug "Emitted push.forced event for #{req.body.repository?.html_url}}"
      robot.emit "github.push.forced", req.body


    res.send 200


