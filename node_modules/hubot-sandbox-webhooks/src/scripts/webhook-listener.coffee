# Description
#   Listen to see when a sandbox is done building,
#   and then let the owner of the sandbox know

module.exports = (robot) ->
  robot.router.post '/hubot/sandbox', (req, res) ->
    robot.logger.info "Sandbox: Received response from sandbox api"

    sandbox = req.body.sandbox
    branch = req.body.branch
    customer_system = req.body.customer_system

    reply = "(successful) Finished moving http://#{sandbox}.luceosolutions-dev.com to #{branch} with config from #{customer_system}."
    if req.body.error
      robot.logger.warning "Sandbox: received failure message from sandbox worker"
      reply = "(failed) Failed to move http://#{sandbox}.luceosolutions-dev.com to #{branch} with config from #{customer_system}. Here's the error:\n"
      reply += req.body.error

    userId = robot.brain.data.sandboxes[sandbox]?.owner
    if userId?
      user = robot.brain.userForId(userId)
      robot.send(user?.jid, reply)
    else
      robot.logger.warning "Sandbox: failed to find user to send response to"

    res.send 200
